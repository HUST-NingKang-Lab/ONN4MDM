getwd()
library(FEAST)
library(doParallel)
meta <- Load_metadata('meta.tsv')
library(readr)
otu <- read_tsv('otu.tsv')
otu <- as.data.frame(read_tsv('otu.tsv'))
rownames(otu) <- otu$taxonomy
otu <- t(as.matrix(otu[, -1]))
common.ids <- intersect(rownames(otu), rownames(meta))
otu_use <- otu[common.ids]
meta_use <- meta[common.ids, ]
otu_use <- otu[common.ids, ]
source('/data2/public/chonghui/sourcetracker/src/SourceTracker.r')
train.ix <- which(metadata_use$SourceSink=='Source')
train.ix <- which(meta_use$SourceSink=='Source')
test.ix <- which(meta_use$SourceSink=='Sink')
st <- sourcetracker(otu_use[train.ix,], meta$Env[train.ix])
foreach(it=1:length(test.ix), .inorder=T, .combine=rbind) %dopar% {
source('/data2/public/chonghui/sourcetracker/src/SourceTracker.r')
result <- as.data.frame(predict(st, otus_use[test.ix[it],], alpha1=alpha1, alpha2=alpha2)$proportions)
{
}}
foreach(it=1:length(test.ix), .inorder=T, .combine=rbind) %dopar% {
source('/data2/public/chonghui/sourcetracker/src/SourceTracker.r')
predict(st, otus_use[test.ix[it],], alpha1=alpha1, alpha2=alpha2)$proportions}
foreach(it=1:length(test.ix), .inorder=T, .combine=rbind) %dopar% {
source('/data2/public/chonghui/sourcetracker/src/SourceTracker.r')
predict(st, otu_use[test.ix[it],], alpha1=alpha1, alpha2=alpha2)$proportions}
alpha1 <- alpha2 <- 0.001
foreach(it=1:length(test.ix), .inorder=T, .combine=rbind) %dopar% {
source('/data2/public/chonghui/sourcetracker/src/SourceTracker.r')
predict(st, otu_use[test.ix[it],], alpha1=alpha1, alpha2=alpha2)$proportions}
cl = makeCluster(10)
registerDoParallel(cl)
results <- foreach(it=1:length(test.ix), .inorder=T, .combine=rbind) %dopar% {
source('/data2/public/chonghui/sourcetracker/src/SourceTracker.r')
predict(st, otu_use[test.ix[it],], alpha1=alpha1, alpha2=alpha2)$proportions}
results
meta[1:4. 1:4]
meta[1:4, 1:4]
getwd()
setwd('../Human_source_tracking/')
meta <- Load_metadata('meta.tsv')
otu <- as.data.frame(read_tsv('otu.tsv'))
rownames(otu) <- otu$taxonomy
otu <- t(as.matrix(otu[, -1]))
common.ids <- intersect(rownames(otu), rownames(meta))
common.ids[1:3]
meta_use <- meta[common.ids, ]
otu_use <- otu[common.ids, ]
train.ix <- which(meta_use$SourceSink=='Source')
test.ix <- which(meta_use$SourceSink=='Sink')
st <- sourcetracker(otu_use[train.ix,], meta$Env[train.ix])
results <- foreach(it=1:length(test.ix), .inorder=T, .combine=rbind) %dopar% {
source('/data2/public/chonghui/sourcetracker/src/SourceTracker.r')
predict(st, otu_use[test.ix[it],], alpha1=alpha1, alpha2=alpha2)$proportions}
results
getwd()
results <- as.data.frame(results)
rownames(results) <- rownames(meta_use)[test.ix]
results
write.csv(results, 'data/SourceTracker/overall_analysis_source_contributions_matrix.csv')
q()
